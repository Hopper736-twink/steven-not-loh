<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Стивен: Битва с Самураем (Optimized)</title>

<style>
body{margin:0;background:#111;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;font-family:monospace}
#game{position:relative;width:100%;max-width:800px;aspect-ratio:4/3;border:4px solid #333}
canvas{width:100%;height:100%;image-rendering:pixelated}
#ui{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;pointer-events:none}
.box{background:rgba(0,0,0,.7);border:2px solid #555;padding:6px;border-radius:6px;color:gold;font-size:11px}
.hearts{display:flex;gap:3px}
.heart{width:14px;height:14px;background:red;clip-path:polygon(50% 15%,61% 0%,78% 0%,93% 15%,93% 35%,50% 85%,7% 35%,7% 15%,22% 0%,39% 0%)}
.empty{background:#333}
#start,#over{position:absolute;inset:0;background:#000c;display:flex;flex-direction:column;justify-content:center;align-items:center;color:white}
#over{display:none}
button{margin-top:15px;padding:12px 30px;font-size:18px;border:none;border-radius:10px;background:#667eea;color:white}
</style>
</head>

<body>
<div id="game">
<canvas id="c" width="800" height="600"></canvas>

<div id="ui">
<div class="box"><div>СТИВЕН</div><div class="hearts" id="hp"></div></div>
<div class="box"><div id="wName"></div><div>урон <span id="wDmg"></span></div></div>
</div>

<div id="start">
<h1>⚔ СТИВЕН ⚔</h1>
<button onclick="start()">НАЧАТЬ</button>
</div>

<div id="over">
<h1 id="res"></h1>
<button onclick="location.reload()">ЕЩЁ РАЗ</button>
</div>
</div>

<script>
const c=document.getElementById("c"),x=c.getContext("2d");
const W=800,H=600,G=480;

let run=false,keys={},mouse=false,last=0,fps=1000/60;

const player={x:100,y:400,w:40,h:60,vx:0,vy:0,hp:50,max:50,spd:5,j:14,cd:0,face:1};
const boss={x:600,y:350,w:50,h:70,hp:250,max:250};

const weapons=[
{name:"МЕЧ",d:6,cd:20},
{name:"БУЛАВА",d:18,cd:45},
{name:"АРБАЛЕТ",d:12,cd:30}
];

function start(){document.getElementById("start").style.display="none";run=true;loop(0)}

function hearts(){
const h=document.getElementById("hp");h.innerHTML="";
for(let i=0;i<Math.ceil(player.max/2);i++){
const d=document.createElement("div");
d.className="heart"+(i>=Math.ceil(player.hp/2)?" empty":"");
h.appendChild(d);
}}

function weaponUI(){
wName.textContent=weapons[player.w||0].name;
wDmg.textContent=weapons[player.w||0].d;
}

function phys(o){
o.vy+=0.7;
o.x+=o.vx;o.y+=o.vy;
if(o.y+o.h>=G){o.y=G-o.h;o.vy=0}
o.x=Math.max(0,Math.min(W-o.w,o.x));
}

function attack(){
if(player.cd>0)return;
player.cd=weapons[player.w||0].cd;
const dx=(boss.x+25)-(player.x+20);
const dy=(boss.y+35)-(player.y+30);
if(dx*dx+dy*dy<10000){
boss.hp-=weapons[player.w||0].d;
if(boss.hp<=0)end(true);
}}

function draw(){
x.fillStyle="#87ceeb";x.fillRect(0,0,W,H);
x.fillStyle="#654321";x.fillRect(0,G,W,200);
x.fillStyle="#FFD700";x.fillRect(player.x,player.y,player.w,player.h);
x.fillStyle="#888";x.fillRect(boss.x,boss.y,boss.w,boss.h);
}

function loop(t){
if(!run)return;
if(t-last<fps){requestAnimationFrame(loop);return;}
last=t;

player.vx=0;
if(keys.a)player.vx=-player.spd;
if(keys.d)player.vx=player.spd;
if(keys.w&&player.y+player.h>=G)player.vy=-player.j;
if(mouse)attack();

player.cd=Math.max(0,player.cd-1);
phys(player); phys(boss);

hearts(); weaponUI(); draw();
requestAnimationFrame(loop);
}

function end(win){
run=false;
document.getElementById("over").style.display="flex";
res.textContent=win?"ПОБЕДА":"ПОРАЖЕНИЕ";
}

document.addEventListener("keydown",e=>{
keys[e.key]=1;
if(e.key>="1"&&e.key<="3")player.w=e.key-1;
});
document.addEventListener("keyup",e=>keys[e.key]=0);
c.onmousedown=()=>mouse=true;
c.onmouseup=()=>mouse=false;

hearts(); weaponUI();
</script>
</body>
</html>
